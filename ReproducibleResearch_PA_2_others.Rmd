---
title: "Best from other doing this assignment"
author: "LKB"
output: html_document
---

```{r}
require(knitr)
opts_chunk$set(echo = TRUE, cache = TRUE, cache.path = "cache/", fig.path = "figure/")
```

We will want to use the years and decades to cluster the data, so we will create new columns with that information.
```{r}
data$YEAR<-year(mdy_hms(paste(data$BGN_DATE,data$TIME_ZONE," ")))
data$DECADE <- as.factor(10*data$YEAR%/%10)
```


#Cleaning data set

How to esimate all types of events

```{r}
ev_type <- as.character(data$EVTYPE)
length(unique(ev_type))

table(table(ev_type)) #to estimate how many of each exits
```


How to efficiently rename events

```{r}
ev_type <- tolower(ev_type)
ev_type[grepl("heat", ev_type)] <- "heat"
```


We have greately unified the type of events. A exploration of the data shows that most of the frequency 1 events are of the type “Summary of…” or other special cases. We will aggregate all those with a frequency smaller than 20 as “others” to perform the analysis, just in case we identify later that this group is relevant for any of the questions.

```{r}
freq_ev_type <- table(ev_type)
ev_type <- sapply(ev_type, function(x) { if(freq_ev_type[x] <= 20) "other" else x})
```

#Sorting cost


```{r}
levels(data$PROPDMGEXP) <-c(0,0,0,0,0,1,2,3,4,5,6,7,8,9,0,0,3,6,6)
levels(data$CROPDMGEXP) <- c(0,0,0,2,9,3,3,6,6)

ata$PROPDMGEXP <- as.numeric(as.character(data$PROPDMGEXP))
data$CROPDMGEXP <- as.numeric(as.character(data$CROPDMGEXP))
data$PROPDMG_VALUE= data$PROPDMG*10^data$PROPDMGEXP/1000000000 # store it in a new column as $ billions.
data$CROPDMG_VALUE= data$CROPDMG*10^data$CROPDMGEXP/1000000000 #v store it in a new column as $ billions.
data$TOTAL_DMG <- data$PROPDMG_VALUE+data$CROPDMG_VALUE
```

mozna tez
```{r}
StormData[StormData$PROPDMGEXP == "K", ]$PROPDMG <- StormData[StormData$PROPDMGEXP == "K", ]$PROPDMG * 1e+03
```

#analysis
```{r}
data_analysis <- tbl_df(select(data, EVENT, STATE, YEAR, DECADE, FATALITIES, INJURIES, PROPDMG_VALUE, CROPDMG_VALUE,TOTAL_DMG))
summary(data_analysis)
```

One student use av per event to draw conclusions as well.


##tools to explore more

students also used

stormData$EVTYPE <‐ gsub("(^ +)|( +$)", "" , stormData$EVTYPE)
stormData$EVTYPE <‐ sub('^\\?$',"NONE",stormData$EVTYPE)

##matching data
Tools to match data
```{r}
getCleanEvent <- function(category){
    cleanStr <- tolower(c("Astronomical Low Tide","Avalanche",
                  "Blizzard","Coastal Flood",
                  "Cold or Wind Chill","Debris Flow",
                  "Dense Fog","Dense Smoke",
                  "Drought","Dust Devil",
                  "Dust Storm","Excessive Heat",
                  "Extreme Cold or Wind Chill","Flash Flood",
                  "Flood","Frost or Freeze",
                  "Funnel Cloud","Freezing Fog",
                  "Hail","Heat",
                  "Heavy Rain","Heavy Snow",
                  "High Surf","High Wind",
                  "Hurricane (Typhoon)","Ice Storm",
                  "Lake Effect Snow","Lakeshore Flood",
                  "Lightning","Marine Hail",
                  "Marine High Wind","Marine Strong Wind",
                  "Marine Thunderstorm Wind","Rip Current",
                  "Seiche","Sleet",
                  "Storm Surge or Tide","Strong Wind",
                  "Thunderstorm Wind","Tornado",
                  "Tropical Depression","Tropical Storm",
                  "Tsunami","Volcanic Ash",
                  "Waterspout","Wildfire",
                  "Winter Storm","Winter Weather"))

    regexStr <- c("(astro).*(low).*(tide)","(avalanc)h?e",
                  "(blizzard)","(coast).*((flood)|(storm)|(surge))",
                  "(^(cold)|((wind).*(chill)))","(debris).*(flow).*",
                  "(dense).*(fog).*","(dense).*(flow).*",
                  "(drought).*","(dust).*(devil).*",
                  "(dust).*(storm)","(excessive).*(heat).*",
                  "(extreme).*(cold).*","(flash).*(flood).*",
                  "(flood).*","((frost)|((freez)(e|i))).*",
                  "(funnel).*(cloud).*","(freezing).*(fog).*",
                  "(hail).*","(heat).*",
                  "(heavy).*(rain).*","(heavy).*(snow).*",
                  "((high)|(heavy)).*((surf)|(wave)|(tide)).*","(high).*(wind).*",
                  "((hurricane)|(typhoon))","(ic)(e|y)+.*(storm)?.*",
                  "(lake).*(snow).*","(lake).*(flood).*",
                  "(lightning).*","(marine).*(hail).*",
                  "(marine).*(high).*(wind).*","(marine).*(strong).*(wind).*",
                  "(marine).*(thunderstorm).*","(rip).*(current).*",
                  "(seiche).*","(sleet).*",
                  "(storm).*(surge).*","(strong).*(wind).*",
                  "((th?un?)+d?(e+r)?s?(to?r?m)|(tstm)|(thunderstrom)).*(wind)?",
                  "(torn((ad)|(da))o).*",
                  "(tropical).*(depression).*","(tropical).*(storm).*",
                  "(tsunami).*","(volcanic).*(ash).*",
                  "(water).*(spout).*","(wild).*(fire).*",
                  "(winter).*(storm).*","(winter).*(weather).*")

    mapping <- cbind(cleanStr,regexStr)

    for(x in 1:nrow(mapping)){
            match <- "unclassified"
            if(grepl(mapping[x,2],category, ignore.case=T)){
                    match <- mapping[x,1]
                    return(match)
                    break
            }
    }
    match
}
```


#Prepating plots

```{r}
fatal <- aggregate(FATALITIES ~ EVTYPE, data = mystorm, FUN = sum)


par(mfrow = c(1, 2), mar = c(10, 4, 5, 4), mgp = c(3, 1, 0), cex = 0.8)
barplot(fatal10$FATALITIES, las = 3, names.arg = fatal10$EVTYPE, main = "Weather Events With The Top 10 Highest Fatalities",
    ylab = "number of fatalities", col = "red")
barplot(injury10$INJURIES, las = 3, names.arg = injury10$EVTYPE, main = "Weather Events With the Top 10 Highest Injuries",
    ylab = "number of injuries", col = "red")
```

or
```{r}
fatalities_by_event <- data_analysis %>%
                        group_by(EVENT) %>%
                        summarise(fatalities=sum(FATALITIES)) %>%
                        arrange(desc(fatalities))
names(fatalities_by_event)<- c("Event","Number of fatalities")
head(fatalities_by_event,10)



g_fatalities <- ggplot(data= data_analysis,aes(x=DECADE, y=FATALITIES)) +
                geom_bar(stat="identity") +
                ylab("Number of Fatalities") +
                xlab("Decades") +
                facet_wrap(~ EVENT) +
                ggtitle("Total number of fatalities by event\n(by decades)") +
                theme(plot.title = element_text(face="bold"),
                      text = element_text(size=10),
                      axis.text.y = element_text(size=6),
                      axis.text.x = element_text(size=6, angle=90, vjust=1))
print(g_fatalities) #i dont think he need to create decate, we can just make specific spacing
```

znak2czas

And he also did this nice summary
```{r}
injuries_by_state <- data_analysis %>%
                        group_by(STATE) %>%
                        summarise(injuries=sum(FATALITIES)) %>%
                        arrange(desc(injuries))
names(injuries_by_state)<- c("State","Number of events with injuries")
head(injuries_by_state,10)
```


U can also do nice colour plots
```{r}
barplot(Health.Fatalities[1:10, 2], col = rainbow(10), legend.text = Health.Fatalities[1:10, 1],
        ylab = "Population Health (Fatalities)", main = "Total of Human Fatalities for Top 10 Weather Events")
```

or somple plot:

```{r}
ggplot(data = prop_damage, aes(x = reorder(weather,‐total), y = total)) +
geom_bar(colour = "black", fill = "blue", stat = "identity") + xlab("Event Type") +
ylab("Cost of Damages") + ggtitle("Property Damage Impact of Weather Events, 1950 ‐ 2011") +
theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
economicdmgPlot <- grid.arrange(overalldmgPlot,
arrangeGrob(propdmgPlot,cropdmgPlot, ncol=1), ncol=2)
#this will plot plots as
# overalldmgPlot propdmgPlot
# 							 cropdmgPlot
```

##comments from forum

* For the value of money, it's not too hard to transform the costs using CPI (consumer price index) with the data taken from the US Bureau of Labor Statistics website. I converted everything into 2011 US dollars.
0votes received.
· flag


#Links to the works

* <http://rpubs.com/pio/severe_events>
* <http://rpubs.com/Junquant/SWEventsAnalysis>
